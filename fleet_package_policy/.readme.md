# Fleet Package Policy Module

This module installs the Fleet package's assets, creates a package policy, and
associates that package policy to an existing agent policy.

## Force Reinstallation Parameter

### Overview

The `force` parameter controls whether Fleet performs a complete reinstallation
of a package even when it's already installed at the requested version. This
parameter has significant implications for package assets and should be used
with full understanding of its impacts.

### What `force = true` Does

When `force = true`, the Fleet API performs the following actions:

#### 1. Bypasses "Already Installed" Check

Normally, if a package version is already installed with status `installed`,
Fleet immediately returns success without taking any action. With
`force = true`, this check is skipped and the full installation process executes
again.

#### 2. Deletes and Recreates Kibana Assets

The installation process explicitly removes old Kibana saved objects before
reinstalling:

- **Affected Assets:** Dashboards, visualizations, searches, and other saved
  objects associated with the package
- **Impact:** Any manual customizations made to these assets (if not cloned) are
  **permanently lost**
- **Result:** Assets are reset to the package's default configuration

#### 3. Aggressively Handles Transforms

Transform handling is particularly destructive with `force = true`:

- **Action:** Existing transforms are deleted
- **Impact:** Transform destination indices are often deleted as well to ensure
  a clean state
- **Data Loss Risk:** Any data accumulated in transform destination indices will
  be **permanently lost**
- **Recovery:** Transforms are recreated from the package specification, but
  historical data is not restored

#### 4. Overwrites Ingest Pipelines and Index Templates

- **Action:** Elasticsearch assets are re-created using "put" operations
- **Impact:** Existing ingest pipelines and index templates with the same names
  are overwritten
- **Result:** Pipelines and templates revert to package defaults

#### 5. Overrides Concurrency Locks

If a package installation is stuck in the `installing` state:

- **Normal Behavior:** Fleet throws a `ConcurrentInstallOperationError` to
  prevent conflicts
- **With `force = true`:** The lock is ignored and installation restarts from
  the beginning (`CREATE_RESTART_INSTALLATION` state)
- **Use Case:** Recovering from failed or hung installations

#### 6. Allows Restricted Operations

`force = true` bypasses several Fleet restrictions:

- **Downgrades:** Allows installing older versions of packages (normally
  blocked)
- **Out-of-date Versions:** Permits installing versions that aren't the latest
- **Agentless Packages:** Allows installing agentless packages even when the
  agentless feature is disabled in Kibana configuration

### When to Use `force = true`

#### Recommended Use Cases

1. **IaC-Managed Infrastructure** (Default)
   - Terraform is the source of truth for all configuration
   - Declarative state should always match the actual state
   - Repeatability and consistency are prioritized
   - Manual customizations are not expected or allowed

2. **Package Version Changes**
   - Reinstalling the same version to reset state
   - Downgrading to an older package version
   - Ensuring all assets match a specific package version exactly

3. **Development and Testing**
   - Iterating on package development with frequent reinstalls
   - Testing package installations in non-production environments
   - CI/CD pipelines that need deterministic, repeatable installations

4. **Asset Reset/Recovery**
   - Restoring customized Kibana assets to package defaults
   - Recovering from corrupted or misconfigured package assets
   - Fixing inconsistencies between package specification and installed assets

5. **Stuck Installation Recovery**
   - Package stuck in `installing` state from a previous failed operation
   - Need to bypass concurrency locks to restart installation

### When to Use `force = false`

#### Recommended Use Cases

1. **Production with Customized Assets**
   - Dashboards or visualizations have been manually customized
   - Customizations need to be preserved across package updates
   - Users have invested time in tuning visualizations for their specific use cases

2. **Environments with Accumulated Transform Data**
   - Transforms have been running and accumulating valuable data
   - Transform destination indices contain historical data that shouldn't be lost
   - Data continuity is critical for analytics or reporting

3. **Normal Package Updates**
   - Upgrading to a new package version (Fleet handles this without `force`)
   - Package is already at the desired version and functioning correctly
   - No need to trigger destructive re-installation

4. **Cautious Production Changes**
   - Production environments where stability is paramount
   - Changes should be incremental and non-destructive
   - Rollback capability is important

### Technical Details of `force=true`

1. **Kibana Assets:** `deleteKibanaSavedObjectsAssets()` removes all saved objects associated with the package
2. **Transforms:** Matching transforms are stopped, deleted, and their destination indices are removed
3. **Pipelines & Templates:** Overwritten via Elasticsearch PUT operations (no explicit deletion needed)
4. **Recreation:** All assets are reinstalled from the package archive after cleanup
