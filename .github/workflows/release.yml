name: release

on:
  workflow_dispatch:
  schedule:
    - cron: '0 13 * * 4' # At 01:00 PM, only on Thur

permissions:
  contents: read

jobs:
  draft:
    permissions:
      contents: write
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Need full history.

      - uses: actions/setup-go@v5
        with:
          go-version: '1.22.x'
          cache-dependency-path: tools/go.sum

      - name: release notes
        id: release-notes
        continue-on-error: true
        run: |
          cd tools && go install ./cmd/release-notes
          release-notes > /tmp/release-notes.txt

      - name: draft GH release
        if: ${{ steps.release-notes.outcome == 'success' }}
        env:
          GH_TOKEN: ${{ github.token }}
        run: | 
          cat /tmp/release-notes.txt
          
          tag="$(date '+v%Y.%m.%d')"
          
          gh release create "${tag}" \
            --notes-file /tmp/release-notes.txt \
            --title "${tag}"
